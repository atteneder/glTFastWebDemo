<!DOCTYPE html>
<html>
<head>
	<title>glTFast Web Demo</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="style.css">
	
</head>
<body>
<header><h1><a href="https://github.com/atteneder/glTFast">glTFast</a> Web Demo</h1>
<form id="urlform">
	<input id="formUrl" type="text" value="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb">
	<button id="loadButton" type="button" disabled>Load</button>
</form>
<div id="preload">
Note: wait for Unity player to finish initializing before loading something.
</div>
<div id="postload" style="visibility: hidden;">
Enter a custom URL to a glTF binary (.glb) and press the "Load" button.
</div>
<div class="openNav" onclick="openNav()">&#9776; Open sample file menu</div>
</header>
<div class="frameContainer">
	<iframe id="glTFast" src="glTFast/index.html"></iframe>
</div>
<aside id="kofi">
<h2>Like it?</h2>
show your appreciation and...<br />
<script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'C0C3BW7G');kofiwidget2.draw();</script> 
</aside>
<div id="mySidenav" class="sidenav">
<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
<h2>Sample files</h2>
<p>source: <a href="https://github.com/KhronosGroup/glTF-Sample-Models" target="_blank">Khronos</a></p>
<ul id="filelist">
</ul>
</div>
<aside id="links">
<a href="about.html" target="_blank">About</a>
<a class="github-button" href="https://github.com/atteneder/glTFast" aria-label="go to atteneder/glTFast on GitHub">glTFast project on GitHub</a>
<a class="github-button" href="https://github.com/atteneder" aria-label="Follow @atteneder on GitHub">Follow @atteneder</a>
<a href="https://twitter.com/tteneder?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false" target="_blank">Follow @tteneder</a>
</aside>
<script type="text/javascript">

	function openNav() {
		document.getElementById("mySidenav").style.width = "350px";
	}

	function closeNav() {
		document.getElementById("mySidenav").style.width = "0";
	}

	function loadLinkList(url,url_prefix) {
		var client = new XMLHttpRequest();
		client.open('GET', url);
		client.onreadystatechange = function() {
			var lines = client.responseText.split(/\r?\n/)
			var arrayLength = lines.length;
			var list = document.getElementById("filelist");
			for (var i = 0; i < arrayLength; i++) {
				let line = lines[i];
				if(!line || line.startsWith('#')) {
					continue;
				}
				let list_item = document.createElement("li");
				let link = document.createElement('a');
				let textnode = document.createTextNode(line);
				
				link.title = line;
				link.href = '#';

				link.addEventListener('click', function(){
					closeNav();
					loadGltf(url_prefix+line);
				});

				link.appendChild(textnode);
				list_item.appendChild(link);
				list.appendChild(list_item);
			}
		}
		client.send();
	}

	function init () {
		var globals = {};
		globals.frame1 = document.getElementById("glTFast");
		globals.formUrl = document.getElementById("formUrl");
		globals.readyCount = 1;

		document.getElementById('loadButton').setAttribute("disabled", "disabled"); 

		globals.onReady = function( instance ) {
			console.log('instance '+instance+' is ready');
			window.globals.readyCount--;
			if(window.globals.readyCount===0) {
				console.log('all is ready');
				var button = document.getElementById('loadButton');
				button.disabled = false;
				button.onclick = function() {submitUrl();};
				document.getElementById('preload').style.visibility = 'hidden';
				document.getElementById('postload').style.visibility = 'visible';
			}

			let params = (new URL(document.location)).searchParams;
    		let filename = params.get("file") || undefined;
			if (filename !== undefined)
				loadGltf(filename);
		}

		window.globals = globals;

		loadLinkList('./glTFast/StreamingAssets/glTF.txt','https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/');
	}

	function loadGltf( url ) {
		if(window.globals.readyCount>0) {
			console.log('unity not ready => abort');
			return;
		}
		window.globals.frame1.contentWindow.gameInstance.Module.SendMessage("TestGui","LoadUrl",url);
		window.globals.frame1.contentWindow.onFileSelected();

		window.globals.formUrl.value = url;
	}

	function submitUrl() {
		loadGltf( window.globals.formUrl.value );
	}

	init();

</script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>